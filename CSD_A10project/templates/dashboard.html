<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dashboard - CyberDetect AI</title>
    <link rel="icon" href="data:,">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Template Stylesheet -->
    <link href="/static/css/style.css" rel="stylesheet">

    <style>
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            height: 100%;
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .ai-robot-icon {
            font-size: 64px;
            color: var(--accent-blue);
            text-align: center;
            margin-bottom: 15px;
        }

        .ai-status {
            text-align: center;
            color: #22c55e;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .ai-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            border: none;
            transition: 0.3s;
            cursor: pointer;
        }

        .ai-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-btn-secondary {
            background: transparent;
            color: var(--accent-blue);
            border: 2px solid var(--accent-blue);
        }

        .ai-btn-secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .status-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid var(--accent-blue);
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .status-label {
            font-size: 13px;
            color: #fff;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-active {
            background: #22c55e;
            color: #fff;
        }

        .badge-ready {
            background: #f59e0b;
            color: #fff;
        }

        .badge-monitored {
            background: var(--accent-blue);
            color: #fff;
        }

        .detection-card {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            border-radius: 6px;
            padding: 15px;
        }

        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .detection-title {
            font-size: 15px;
            font-weight: 700;
            color: #ef4444;
        }

        .detection-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #f59e0b;
            color: #fff;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .recommendation {
            font-size: 12px;
            color: #eee;
            font-style: italic;
            line-height: 1.5;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg navbar-dark px-4 px-lg-5 py-3 py-lg-0 sticky-top">
        <a href="" class="navbar-brand p-0">
            <h1>CyberDetect AI</h1>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
                <a href="{{url_for('viewdata')}}" class="nav-item nav-link">VIEWDATA</a>
                <a href="{{url_for('algo')}}" class="nav-item nav-link">ALGO</a>
                <a href="{{url_for('upload')}}" class="nav-item nav-link">UPLOAD</a>
                <a href="{{url_for('prediction')}}" class="nav-item nav-link">PREDICTION</a>
                <a href="{{url_for('dashboard')}}" class="nav-item nav-link active">DASHBOARD</a>
                <a href="{{url_for('forensics')}}" class="nav-item nav-link">FORENSICS</a>
                <a href="{{url_for('logout')}}" class="nav-item nav-link">LOGOUT</a>
            </div>
        </div>
    </nav>
    <!-- Navbar End -->

    <div class="container-fluid py-4 px-4">
        <!-- Top Row -->
        <div class="row g-3 mb-3">
            <!-- Attack Distribution Chart -->
            <div class="col-lg-4">
                <div class="stat-card">
                    <p class="card-title"><i class="fas fa-shield-alt text-info"></i></p>
                    <div style="height: 280px; position: relative;">
                        <canvas id="attackChart"></canvas>
                    </div>
                    <div id="attackLegend" class="mt-3 d-flex flex-wrap gap-3 justify-content-center"
                        style="font-size: 11px;"></div>
                </div>
            </div>

            <!-- Traffic Chart -->
            <div class="col-lg-4">
                <div class="stat-card">
                    <p class="card-title"><i class="fas fa-chart-line text-info"></i>Packets/sec</p>
                    <div style="height: 280px;">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Status Panel -->
            <div class="col-lg-4">
                <div class="stat-card">
                    <div class="ai-robot-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-status">
                        <i class="fas fa-check-circle me-2"></i>Online & Protecting
                    </div>
                    <button class="ai-btn ai-btn-primary" onclick="location.href='/prediction'">
                        Start New Scan
                    </button>
                    <button class="ai-btn ai-btn-secondary" onclick="location.href='/upload'">
                        Process Dataset
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Row -->
        <div class="row g-3">
            <!-- Recent Detection -->
            <div class="col-lg-8">
                <div class="stat-card">
                    <p class="card-title"><i class="fas fa-bell text-danger"></i></p>
                    <div id="recentDetection">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="col-lg-4">
                <div class="stat-card">
                    <p class="card-title"><i class="fas fa-cogs text-info"></i></p>
                    <div class="status-indicator">
                        <span class="status-label">Ensemble Models</span>
                        <span class="status-badge badge-active">Active</span>
                    </div>
                    <div class="status-indicator">
                        <span class="status-label">WSN Nodes</span>
                        <span class="status-badge badge-monitored" id="nodeCount">100 Monitored</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Chart.js defaults
            Chart.defaults.color = 'rgba(255, 255, 255, 0.5)';
            Chart.defaults.font.family = "'Inter', sans-serif";

            // Attack Vector Chart
            const attackCtx = document.getElementById('attackChart').getContext('2d');
            const attackChart = new Chart(attackCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal'],
                    datasets: [{
                        data: [100],
                        backgroundColor: ['#d946ef'],
                        borderWidth: 0,
                        hoverOffset: 10,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Custom Legend
            function updateAttackLegend() {
                const legendEl = document.getElementById('attackLegend');
                if (!legendEl) return;
                legendEl.innerHTML = '';
                attackChart.data.labels.forEach((label, i) => {
                    const color = attackChart.data.datasets[0].backgroundColor[i];
                    legendEl.innerHTML += `
                        <div class="d-flex align-items-center">
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; margin-right: 8px;"></div>
                            <span style="color: #fff; opacity: 0.8;">${label}</span>
                        </div>
                    `;
                });
            }
            updateAttackLegend();

            // Traffic Chart
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            const trafficGradient = trafficCtx.createLinearGradient(0, 0, 0, 200);
            trafficGradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
            trafficGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            const trafficChart = new Chart(trafficCtx, {
                type: 'line',
                data: {
                    labels: Array(10).fill(''),
                    datasets: [{
                        label: 'Packets',
                        data: [20, 25, 22, 28, 30, 25, 20, 18, 22, 25],
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: trafficGradient,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false } },
                        y: {
                            display: true,
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });

            // Update Dashboard
            function updateDashboard() {
                console.log('[Dashboard] Fetching stats...');
                $.get('/api/stats?t=' + new Date().getTime(), function (data) {
                    console.log('[Dashboard] Received data:', data);
                    if (data.status === 'success') {
                        const attackCounts = data.analytics.by_type || {};

                        // Update Doughnut
                        const typeLabels = Object.keys(attackCounts);
                        const typeData = Object.values(attackCounts);
                        if (typeLabels.length > 0) {
                            // Color mapping
                            const colorMap = {
                                'Normal': '#d946ef',
                                'Grayhole': '#f59e0b',
                                'Blackhole': '#9333ea',
                                'TDMA': '#3b82f6',
                                'Flooding': '#ef4444'
                            };
                            const colors = typeLabels.map(l => colorMap[l] || '#6366f1');

                            attackChart.data.labels = typeLabels;
                            attackChart.data.datasets[0].data = typeData;
                            attackChart.data.datasets[0].backgroundColor = colors;
                            attackChart.update();
                            updateAttackLegend();
                        }

                        // Update Traffic
                        if (data.analytics.traffic_intensity) {
                            trafficChart.data.datasets[0].data = data.analytics.traffic_intensity;
                            trafficChart.update();
                        }

                        // Update Recent Detection
                        if (data.recent_logs && data.recent_logs.length > 0) {
                            const log = data.recent_logs[0];

                            let time = 'N/A';
                            if (log.timestamp) {
                                const tStr = log.timestamp.replace(' ', 'T');
                                time = new Date(tStr).toLocaleString();
                            }

                            const nodeId = (log.node_id || '').toString().toLowerCase().startsWith('node-')
                                ? log.node_id : `Node-${log.node_id}`;

                            $('#recentDetection').html(`
                                <div class="detection-card">
                                    <div class="detection-header">
                                        <span class="detection-title">${log.attack_type} detected</span>
                                        <span class="detection-time">${time}</span>
                                    </div>
                                    <div class="severity-badge">${log.severity} Severity</div>
                                    <div class="recommendation">
                                        <strong>Recommendation:</strong> ${log.mitigation}
                                    </div>
                                </div>
                            `);
                        }

                        // Update node count
                        const total = data.analytics.dataset_total || 0;
                        $('#nodeCount').text(`${total} Monitored`);
                    }
                });
            }

            setInterval(updateDashboard, 3000);
            updateDashboard();
        });
    </script>
    {% include 'chatbot_fragment.html' %}
</body>

</html>